<!DOCTYPE html>
<html lang="ko">
    <head>
        <title>My board main</title>
    </head>

    <body>
        <h1><a href="{{ url_for('main') }}">Flask로 만든 간단한 게시판</a></h1>

        <br>

        {% include 'frame_member.html' %}

        <br>

        <h3><a href="{{ url_for('board', board=board) }}">{{ board_name }} 게시판</a></h3>

        <div class="article" style="border:1px solid black; padding: 10px">
            <h3>{{ article_title }}</h3>
            {% if board == 'anonymous' %}
            <div style="float:left;">익명 | {{ article_date }}</div>
            {% else %}
            <div style="float:left;">{{ article_uid }} | {{ article_date }}</div>
            {% endif %}
            <div style="float:right;">조회수 {{ article_view }} | 추천 {{ article_hit }}</div>
            <input type="hidden" id="aid" value='{{ aid }}'>
            <br><br>
            <div class="content" style="border:1px dashed gray; padding: 10px; min-height: 300px;">
                <pre>{{ article_content }}</pre>
            </div>
            
            <br>

            <div class="btns" align="center">
                <script>
                    function sendHit(){
                        let aid = document.getElementById( 'aid' ).value;
                        let uid = document.getElementById( 'uid' ).value;

                        if (uid === ''){
                            alert("추천은 로그인한 유저만 가능합니다.");

                            return
                        }

                        const formData = new FormData();
                        const url = '/article/hit';
                        let signal = true;

                        formData.append('aid', aid);
                        formData.append('uid', uid);

                        fetch (url, { method: 'POST', body: formData })
                        .then(response=>{
                            if ([200, 400, 500].includes(response.status))
                                return response.json()
                            else{
                                signal = false;
                                alert("추천 실패");
                            }
                        }).catch(err => {
                            if (signal){
                                signal = false;
                                alert("추천 실패");
                            }
                        }).then(result => {
                            if (result['result'])
                                window.location.reload(true);
                            else if (signal){
                                signal = false;
                                alert(result['msg']);
                            }
                        });
                    }
                </script>
                <button onclick="return sendHit()">추천하기 ({{ article_hit }})</button>
            </div>

            <br>

            <h5>댓글 {{ comments | length }}개</h5>
            <div class="comments" style="border:1px dashed gray; padding: 10px; min-height: 50px;">
                {% if comments %}
                <script>
                    function sendDeleteComment(cid){
                        let uid = document.getElementById( 'uid' ).value;

                        if (uid === ''){
                            alert("삭제 권한이 없습니다.");

                            return
                        }

                        const formData = new FormData();
                        const url = '/comment/delete';
                        let signal = true;

                        formData.append('uid', uid);
                        formData.append('cid', cid);

                        fetch (url, { method: 'POST', body: formData })
                        .then(response=>{
                            if (response.status === 200)
                                return response.json()
                            else{
                                signal = false;
                                alert("삭제 실패");
                            }
                        }).catch(err => {
                            if (signal){
                                signal = false;
                                alert("삭제 실패");
                            }
                        }).then(result => {
                            if (result['result'])
                                window.location.reload(true);
                            else if (signal){
                                signal = false;
                                alert("삭제 실패");
                            }
                        }).catch(err => {
                            if (signal)
                                alert("삭제 실패");
                        });
                    }
                </script>
                <table style="width: 90%;">
                    {% for cid, cuid, comment, cdate_time in comments %}
                    <tr align="center">
                        {% if board == 'anonymous' %}
                            {% if cuid == article_uid %}
                            <td style="width: 10%;">글쓴이</td>
                            {% else %}
                            <td style="width: 10%;">익명</td>
                            {% endif %}
                        {% else %}
                        <td style="width: 10%;">{{ cuid }}</td>
                        {% endif %}
                        <td align="left" style="width: 65%;">{{ comment }}</td>
                        <td align="right" style="width: 20%;">{{ cdate_time }}</td>
                        {% if cuid == session.get('uid') %}
                        <td align="right" style="width: 5%;" onclick="return sendDeleteComment({{cid}})">삭제</td>
                        {% else %}
                        <td align="right" style="width: 5%;">&nbsp;</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                    <p align='center'>아직 등록된 댓글이 없습니다.</p>
                {% endif %}
            </div>

            <br>

            <div class="write-comment" style="border:1px dashed gray; padding: 10px; min-height: 50px;">
                {% if session['uid'] %}
                <script>
                    function sendComment() {
                        let aid = document.getElementById( 'aid' ).value;
                        let uid = document.getElementById( 'uid' ).value;
                        let comment = document.getElementById( 'comment' ).value;

                        const formData = new FormData();
                        const url = '/comment/write';
                        let signal = true;

                        formData.append('aid', aid);
                        formData.append('uid', uid);
                        formData.append('comment', comment);

                        fetch (url, { method: 'POST', body: formData })
                        .then(response=>{
                            if ([200, 400, 500].includes(response.status))
                                return response.json()
                            else{
                                signal = false;
                                alert("댓글 등록 실패");
                            }
                        }).catch(err => {
                            if (signal){
                                signal = false;
                                alert("댓글 등록 실패");
                            }
                        }).then(result => {
                            if (result['result'])
                                window.location.reload(true);
                            else if (signal){
                                signal = false;
                                alert(result['msg']);
                            }
                        });
                    };
                </script>
                <p>
                    <label>{{ session.get('uid') }}</label><br><br>
                    <input onkeydown="if(event.keyCode==13) return sendComment()" type="text" id="comment" style="width:80%; height: 50px; resize: none;"></textarea>
                    
                    <button onclick="return sendComment()" type="submit" style="width:80px; height:40px">댓글 달기</button>
                </p>
                {% else %}
                <p align='center'>로그인 한 유저만 댓글을 작성할 수 있습니다.</p>
                {% endif %}
            </div>

            <br>

            <div class="btns">
                {% if session.get('uid') == article_uid %}
                <form name="update_article" action="{{ url_for('acrticleUpdate', board=board) }}" method="post">
                    <input type="hidden" name="uid" value="{{ session.get('uid') }}">
                    <input type="hidden" name="aid" value="{{ aid }}">
                </form>
                <form name="delete_article" action="{{ url_for('articleDalete', board=board) }}" method="post">
                    <input type="hidden" name="uid" value="{{ session.get('uid') }}">
                    <input type="hidden" name="aid" value="{{ aid }}">
                </form>
                <a onclick="javascript:document.update_article.submit();">수정</a>
                <a onclick="javascript:document.delete_article.submit();">삭제</a>
                {% endif %}
                <a href="{{ url_for('articleCreate', board=board) }}">글쓰기</a>
            </div>
        </div>
    </body>
</html>