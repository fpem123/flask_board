<!DOCTYPE html>
<html lang="ko">
    <head>
        <title>My board main</title>
    </head>

    <body>
        <h1><a href="{{ url_for('main') }}">Flask로 만든 간단한 게시판</a></h1>

        <br>
        
        <h3><a href="{{ url_for('board', board=board) }}">{{ board_name }} 게시판</a></h3>

        <div class="article" style="border:1px solid black; padding: 10px">
            <h3>{{ title }}</h3>
            <div style="float:left;">{{ uid }} | {{ date }}</div>
            <div style="float:right;">조회수 {{ view }} | 추천 {{ hit }}</div>
            <input type="hidden" id="aid" value='{{ aid }}'>
            <br><br>
            <div class="content" style="border:1px dashed gray; padding: 10px; min-height: 300px;">
                <pre>{{ content }}</pre>
            </div>
            
            <br>

            <div class="btns" align="center">
                <script>
                    function sendHit(){
                        let aid = document.getElementById( 'aid' ).value;
                        let uid = document.getElementById( 'uid' ).value;

                        if (uid === ''){
                            alert("추천은 로그인한 유저만 가능합니다.");

                            return
                        }

                        const formData = new FormData();
                        const url = '/article/hit';
                        let signal = true;

                        formData.append('aid', aid);
                        formData.append('uid', uid);

                        fetch (url, { method: 'POST', body: formData })
                        .then(response=>{
                            if (response.status === 200)
                                return response.json()
                            else{
                                signal = false;
                                alert("추천 실패");
                            }
                        }).catch(err => {
                            if (signal){
                                signal = false;
                                alert("추천 실패");
                            }
                        }).then(result => {
                            if (result['result'])
                                window.location.reload(true);
                            else if (signal){
                                signal = false;
                                alert("추천은 1회만 가능합니다.");
                            }
                        }).catch(err => {
                            if (signal)
                                alert("추천 실패");
                        });
                    }
                </script>
                <button onclick="return sendHit()">추천하기 ({{ hit }})</button>
            </div>

            <br>

            <h5>댓글 {{ num_comment }}개</h5>
            <div class="comments" style="border:1px dashed gray; padding: 10px; min-height: 50px;">
                {% if comments %}
                <table style="width: 90%;">
                    {% for cid, uid, comment, date_time in comments%}
                    <tr align="center">
                        <td style="width: 10%;">{{ uid }}</td>
                        <td align="left" style="width: 65%;">{{ comment }}</td>
                        <td align="right" style="width: 20%;">{{ date_time }}</td>
                        <td align="right" style="width: 5%;">삭제</td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                    <p align='center'>아직 등록된 댓글이 없습니다.</p>
                {% endif %}
            </div>

            <br>

            <script>
                function sendComment() {
                    let aid = document.getElementById( 'aid' ).value;
                    let uid = document.getElementById( 'uid' ).value;
                    let pwd = document.getElementById( 'pwd' ).value;
                    let comment = document.getElementById( 'comment' ).value;

                    const formData = new FormData();
                    const url = '/comment/write_submit';
                    let signal = true;

                    formData.append('aid', aid);
                    formData.append('uid', uid);
                    formData.append('pwd', pwd);
                    formData.append('comment', comment);

                    fetch (url, { method: 'POST', body: formData })
                    .then(response=>{
                        if (response.status === 200)
                            return response.json()
                        else{
                            signal = false;
                            alert("댓글 등록 실패");
                        }
                    }).catch(err => {
                        if (signal){
                            signal = false;
                            alert("댓글 등록 실패");
                        }
                    }).then(result => {
                        if (result['result'])
                            window.location.reload(true);
                        else if (signal){
                            signal = false;
                            alert("댓글 등록 실패");
                        }
                    }).catch(err => {
                        if (signal)
                            alert("댓글 등록 실패");
                    });
                };
            </script>

            <div class="write-comment" style="border:1px dashed gray; padding: 10px; min-height: 50px;">
                <input type="text" id="uid" placeholder="ID" 
                maxlength='10' style="width:100px; height:20px;" onkeydown="if(event.keyCode==13) return false">
                <input type="password" id="pwd" placeholder="PASSWORD" 
                maxlength='10' style="width:100px; height:20px;" onkeydown="if(event.keyCode==13) return false">
                <br>
                <input onkeydown="if(event.keyCode==13) return sendComment()" type="text" id="comment" style="width:80%; height: 50px; resize: none;"></textarea>
                <br>
                <button onclick="return sendComment()" type="submit" style="width:80px; height:40px">댓글 달기</button>
            </div>

            <br>

            <div class="btns">
                <a href="{{ url_for('userChect', board=board, uid=uid, aid=aid, check_type='U') }}">수정</a>
                <a href="{{ url_for('userChect', board=board, uid=uid, aid=aid, check_type='D') }}">삭제</a>
                <a href="{{ url_for('articleCreate', board=board) }}">글쓰기</a>
            </div>
        </div>
    </body>
</html>